# -*- coding: utf-8 -*-
"""Training the Dataset

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jTnRQRDf6PaxSekK-jzOsmtyBLxrcJUR
"""

import pandas as pd
import numpy as np
!pip install optuna
import optuna
!pip install catboost
from catboost import CatBoostRegressor, Pool
from sklearn.metrics import mean_squared_error, mean_absolute_error
from sklearn.model_selection import train_test_split
import os

# --- 1. DATA LOADING and PREPARATION ---


df = pd.read_csv('/content/movie_prediction_dataset_final.csv')
df = df.dropna(subset=['First_Week_Income'])
df = df[df['First_Week_Income'] > 0]

# Define all 17 features and the target
feature_cols = [
    'release_year', 'budget', 'runtime', 'is_sequel',
    'director_name', 'director_popularity',
    'lead_actor1', 'lead_actor1_popularity',
    'primary_genre', 'genre2',
    'studio_1', 'studio_2', 'brand_name',
    'mpaa_rating', 'release_month', 'is_holiday_release', 'Distributor'
]
target_col = 'First_Week_Income'

X = df[feature_cols]
y = df[target_col]

# Define Categorical Features
cat_features = [
    'director_name', 'lead_actor1',
    'primary_genre', 'genre2',
    'studio_1', 'studio_2', 'brand_name',
    'mpaa_rating', 'Distributor'
]

# Impute missing numerical/categorical values before splitting (if any are still NaN)
X = X.fillna(X.select_dtypes(include=[np.number]).median())
X = X.fillna('Unknown')

# --- 2. TRAIN/VALIDATION SPLIT for Optuna ---
X_train, X_val, y_train, y_val = train_test_split(X, y, test_size=0.2, random_state=42)

# --- 3. HYPERPARAMETER TUNING (Optuna) ---

def objective(trial):
    """Defines the search space for Optuna to minimize RMSE."""

    # Set hyperparameter search space
    cat_params = dict(
        iterations=trial.suggest_int("iterations", 300, 1500),
        learning_rate=trial.suggest_float("learning_rate", 1e-4, 0.1, log=True),
        depth=trial.suggest_int("depth", 4, 10),
        l2_leaf_reg=trial.suggest_float("l2_leaf_reg", 1e-8, 100.0, log=True),
        bagging_temperature=trial.suggest_float('bagging_temperature', 0, 1.0),
        random_strength=trial.suggest_float("random_strength", 1e-8, 1.0, log=True),
        task_type='CPU',
        early_stopping_rounds=150,
        verbose=0,
        loss_function='RMSE',
        random_seed=42
    )

    # Create CatBoost Pool objects
    X_train_pool = Pool(X_train, y_train, cat_features=cat_features)
    X_valid_pool = Pool(X_val, y_val, cat_features=cat_features)

    model = CatBoostRegressor(**cat_params)
    model.fit(X=X_train_pool, eval_set=X_valid_pool)

    y_pred = model.predict(X_val)
    # Calculate RMSE (Root Mean Squared Error)
    score = np.sqrt(mean_squared_error(y_val, y_pred))

    return score

# Create and optimize the study
print("Starting Optuna Hyperparameter Tuning...")
study = optuna.create_study(direction='minimize', sampler=optuna.samplers.TPESampler(seed=42))
study.optimize(objective, n_trials=250)
print(f"\nOptuna Best RMSE: {study.best_value:,.2f}")
print(f"Optuna Best Hyperparameters: {study.best_params}")

# Optional: Save the study results
# joblib.dump(study, 'optuna_movie_study.pkl')

# --- 4. TRAIN FINAL MODEL & SAVE ---

best_params = study.best_params

# Train the final model using the best parameters found on the FULL dataset (X, y)
final_model = CatBoostRegressor(
    **best_params,
    cat_features=cat_features,
    task_type='CPU',
    loss_function='RMSE',
    verbose=0
)

X_full_pool = Pool(X, y, cat_features=cat_features)
final_model.fit(X=X_full_pool)

# Save the model
model_filename = 'catboost_tuned_movie_predictor.cbm'
final_model.save_model(model_filename)
print(f"\nModel successfully saved as: {model_filename}")

# --- 5. PREDICT AVATAR: FIRE AND ASH ---

# Load the saved model (Demonstrating load functionality)
loaded_model = CatBoostRegressor()
loaded_model.load_model(model_filename)

# Construct the feature vector for Avatar: Fire and Ash (lead_actor2 removed, genre1 -> primary_genre)
avatar_data = {
    'release_year': 2025,
    'budget': 250000000,
    'runtime': 197,
    'is_sequel': 1,
    'director_name': 'James Cameron',
    'director_popularity': 5.0,
    'lead_actor1': 'Sam Worthington',
    'lead_actor1_popularity': 4.5,

    'primary_genre': 'Adventure',
    'genre2': 'Fantasy',
    'studio_1': '20th Century Studios',
    'studio_2': 'Lightstorm Entertainment',
    'brand_name': 'Avatar',
    'mpaa_rating': 'PG-13',
    'release_month': 12,
    'is_holiday_release': 1,
    'Distributor': '20th Century Studios'
}

avatar_df = pd.DataFrame([avatar_data])

# Ensure the columns are in the exact order as the training data
avatar_df = avatar_df[feature_cols]

predicted_income = loaded_model.predict(avatar_df)[0]

print(f"\n--- Prediction for 'Avatar: Fire and Ash' (Tuned Model) ---")
print(f"Predicted First Week Income: ${predicted_income:,.2f}")